# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - backend/*
    - azure-pipelines-backend.yml

stages:
# pipeline stage to compile backend code 
- stage: BuildPayrollBackend
  jobs:
  - job: BuildPayrollBackend
    displayName: Build Payroll Backend with Maven
    pool:
      vmImage: ubuntu-latest
    steps:
      - task: Maven@3
        inputs:
          mavenPomFile: 'backend/pom.xml'
          mavenOptions: '-Xmx3072m'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: '1.11'
          jdkArchitectureOption: 'x64'
          publishJUnitResults: true
          testResultsFiles: '**/surefire-reports/TEST-*.xml'
          goals: 'package'

# pipeline stage to build and push the backend container to a docker registry, authenticated through service connection 
- stage: PushBackendContainerImage
  dependsOn:
  - BuildPayrollBackend
  condition: succeeded('BuildPayrollBackend')
  jobs:
  - job: PushBackendImage
    displayName: Push Backend container image to hub

    steps:
      - task: Maven@3
        displayName: Build Docker image
        inputs:
          mavenPomFile: 'backend/pom.xml'
          goals: 'spring-boot:build-image'
          publishJUnitResults: false
          jdkVersionOption: '1.11'